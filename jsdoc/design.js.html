<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Experigen documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link href="styles/bootstrap.css" rel="stylesheet">
    <link href="styles/docs.css" rel="stylesheet">
    <link href="styles/bootstrap-custom.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <header class="header navbar navbar-inverse">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="#"><strong>Experigen</strong> documentation</a>
        </div>
      </div>
    </header>

    <div class="container-fluid">
      <div class="row-fluid">
          <div class="span4">
              <h2><a href="index.html">Index</a></h2><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Classes</li><li><a href="Array.html"><i class="icon-shield" style="color: #0186d1"></i> Array</a></li><li><a href="Experigen.new_progressbar.html"><i class="icon-shield" style="color: #0186d1"></i> new_progressbar</a></li><li><a href="Experigen.trial.html"><i class="icon-shield" style="color: #0186d1"></i> trial</a></li><li><a href="VAS.html"><i class="icon-shield" style="color: #0186d1"></i> VAS</a></li><li><a href="WavPlayer.html"><i class="icon-shield" style="color: #0186d1"></i> WavPlayer</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Namespaces</li><li><a href="Experigen.html"><i class="icon-code"></i> Experigen</a></li></ul></div><div class="well well-small"><ul class="nav nav-list"><li class="nav-header">Global</li><li><a href="global.html#addRSE"><i class="icon-globe" style="color: black;"></i> addRSE</a></li><li><a href="global.html#getCookie"><i class="icon-globe" style="color: black;"></i> getCookie</a></li><li><a href="global.html#listscreens"><i class="icon-globe" style="color: black;"></i> listscreens</a></li><li><a href="global.html#makeVAS"><i class="icon-globe" style="color: black;"></i> makeVAS</a></li><li><a href="global.html#playWAVSound"><i class="icon-globe" style="color: black;"></i> playWAVSound</a></li><li><a href="global.html#reportSoundProblem"><i class="icon-globe" style="color: black;"></i> reportSoundProblem</a></li><li><a href="global.html#setCookie"><i class="icon-globe" style="color: black;"></i> setCookie</a></li><li><a href="global.html#ttest"><i class="icon-globe" style="color: black;"></i> ttest</a></li><li><a href="global.html#VASplugin"><i class="icon-globe" style="color: black;"></i> VASplugin</a></li></ul></div>
          </div>

          <div class="span8">
              <h1 class="page-header">Source: setup/design.js</h1>
              



    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @file Contains the main setup of the experiment, and experiment-specific functions
 * @todo Clean up functions that do not belong here.
 */


/**
 * Sets a cookie in the web browser
 * @param name {String} Name of the cookie
 * @param value Value of the cookie to set
 * @param [days] {Number} Days for the cookie to expire
 */
setCookie = function (name, value, days) {
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
    } else var expires = "";
    document.cookie = escape(name) + "=" + escape(value) + expires + "; path=/";
}


/**
 * Gets a cookie from the web browser
 * @param name {String}Name of the cookie
 * @returns {String} Value of the cookie, or null if no such cookie
 */

getCookie = function (name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i = 0; i &lt; ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0) == ' ') c = c.substring(1, c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
	}
    return null;
};


/**
 * Just a helper function to be used in the Console: lists all the screens within Experigen
 * to the console log, with their index and view
 * @returns {Array} List of objects, where a[i].n == i and a[i].view is the name of the view
 */
listscreens = function() {
	var ret = [];
	for(var i = Experigen.position; i &lt; Experigen._screens.length; i++){
	    ret.push({n: i, view: Experigen._screens[i].view});
		console.log("n: " + i, ", view: " + Experigen._screens[i].view);
	}
	return ret;
}

/**
 * Records the demographics response, with validation with regards to age and native command
 * of English. It accesses DOM elements directly, so change the demographics form together
 * with this!
 * @param that The sending button (just call with _this_)
 */
Experigen.recordDemographicsResponse = function(that){
	/** year of birth */
 	var yob = parseInt($("select[name=yearofbirth]").val());
	/** English -- acquired or not? */
	var enga = parseInt($("input[name=englishacquired]").val());
	var cont = 1; // continue?
	if(yob>=1995) cont = 0;
	if($("select[name=onlyenglish]").val()!="yes"){ // if bilingual
		if(isNaN(enga)) enga = 10; // if did not set, let's not trust them
		if(enga > 6) cont = 0; // don't continue
	}
	
	if($("select[name=speechimpairment]").val()!="no" || $("select[name=heairingimpairment]").val()!="no") cont = 0; // don't continue with impairments
	
	if($("input[name=headphones]").val()=="" || $("input[name=headphones]").val()=="none") cont = 0; // don't continue without headphones
	
	if(!cont){
		this.addStaticScreen("goodbyedemo.ejs");  // Adding the static goodbye screen
		this.rewind(this._screens.length-1); // Jumping there
	}
	Experigen.recordResponse(that); // forward to default Experigen behavior
}


/**
 * Provides the final thanks string, which includes info about how many blocks can be done without rerunning
 * the eligibility test.
 * @returns {String} A presentable output.
*/
Experigen.finalThanksStr = function(){
	var blocks = Experigen.getBlocksDone();
	var remain = 5 - (blocks.length % 5); // every fifth!
	var out = "";
	if(remain == 5){
		out = "";
	}
	else if (remain == 1){
		out = "You may come back and complete another block without taking the eligibility test again, if you use the same browser on the same computer. After that block, your pass will expire. ";
	}
	else {
		out = "You may come back and complete another " + remain + " blocks without taking the eligibility test again, if you use the same browser on the same computer. After those " + remain + " blocks your pass will expire. ";
	}
	return out;
}


/**
 * Records an answer during training -- keeps a tally of correct choices.
 * @param given {String} The caption of the button pressed (correct/incorrect)
 * @param cr {String} The correct response based on the spreadsheet
 * @returns {String} The presentable feedback string
 */
Experigen.trainingAnswer = function(given,cr) {
	var userResponse = given == 'correct' ? 1 : 0;
	Experigen.accuracyTotal++;
	Experigen.accuracy+=(userResponse==cr);
	if(userResponse==cr)
		return 'Your answer is right.';
	else
		return 'Our expert listeners gave this a rating of ' + (cr==1 ? 'correct.' : 'incorrect.');
}



/**
 * Calculates whether the subject got over the threshold for catch trials, and returns
 * a readable feedback.
 * @returns {String} The presentable feedback string.
*/

Experigen.calculateCatches = function () {
	var resp = []; // responses to catches
	var intend = []; // the correct responses to catches
	for(var i = 0; i &lt; Experigen.catches.length; i++) { // fill up these arrays
		resp.push(Experigen.catches[i].judgment);
		intend.push(parseInt(Experigen.catches[i].intended));
	}

	var prompt;
	var correct = 0;
	for(var i = 0; i &lt; resp.length; i++)
		if(intend[i] == resp[i]) correct++;
	

	if(correct / resp.length >= .8){ // If over 80%, they are OK
		prompt = "You have met the minimum accuracy criterion on our attention trials. Your responses are recorded.&lt;br>";
	}
	else {
		prompt = "We are sorry, you did not meet the minimum accuracy criterion on our attention trials. Your responses will be subject to further review, and they may be rejected. &lt;br>";
	
		// Let's give some numbers, if it's a tester it could help.
		prompt += "&lt;br> correct percentage = " + (correct/resp.length*100).toFixed(1);
		prompt += ("&lt;br> correct = " + correct + ", resp.length = " + resp.length + ", resp[0] = " + resp[0] + ", intend[0] = " + intend[0]);
		prompt += (", resp[1] = " + resp[1] + ", intend[1] = " + intend[1] + ", resp[2] = " + resp[2] + ", intend[2] = " + intend[2] + ",");
		prompt += (", Experigen.catches: " + Experigen.catches.toString() + " +.");
	}
	
	return prompt;
}


/**
 * The returned object from a t-test:
 * @typedef {Object} ttestReturn
 * @property lower_bound The lower bound of the 95% confidence interval
 * @property upper_bound The upper bound of the 95% confidence interval
 */


/**
 * Calculates a 2-sample unequal-variance t-test.
 * @param vals {Array} An array with 2 arrays of numbers as members.
 * @return {ttestReturn} An object with the 95% confidence interval 
 * of the difference between the two samples
 */
ttest = function(vals){
	var tcrits = [12.7065, 4.3026, 3.1824, 2.7764, 2.5706, 2.4469, 2.3646, 2.306, 2.2621, 2.2282, 2.201, 2.1788, 2.1604, 2.1448, 2.1314, 2.1199, 2.1098, 2.1009, 2.093, 2.086, 2.0796, 2.0739, 2.0686, 2.0639, 2.0596, 2.0555, 2.0518, 2.0484, 2.0452, 2.0423, 2.0395, 2.0369, 2.0345, 2.0322, 2.0301, 2.0281,2.0262, 2.0244, 2.0227, 2.0211, 2.0196, 2.0181, 2.0167, 2.0154, 2.0141, 2.0129, 2.0117, 2.0106, 2.0096, 2.0086, 2.0076, 2.0066, 2.0057, 2.0049, 2.0041, 2.0032, 2.0025, 2.0017, 2.001, 2.0003, 1.9996, 1.999, 1.9983, 1.9977, 1.9971, 1.9966, 1.996, 1.9955, 1.995, 1.9944, 1.9939, 1.9935, 1.993, 1.9925, 1.9921,1.9917, 1.9913, 1.9909, 1.9904, 1.9901, 1.9897, 1.9893, 1.9889, 1.9886, 1.9883, 1.9879, 1.9876, 1.9873, 1.987, 1.9867, 1.9864, 1.9861, 1.9858, 1.9855,1.9852, 1.985, 1.9847, 1.9845, 1.9842, 1.984];
	if(vals.length != 2) throw "Two sets needed for t-test";
	var params = [{},{}];
	for(var i = 0; i &lt; 2; i++){
		var s = 0, ss=0;
		for(var j = 0; j &lt; vals[i].length; j++){
			s+= vals[i][j];
			ss+= vals[i][j]*vals[i][j];
		}
		params[i].mean = s/vals[i].length;
		params[i].n = vals[i].length;
		params[i].variance = (ss - ((s*s)/params[i].n))/(params[i].n-1);
		params[i].spn = params[i].variance/params[i].n;
	}
	var df = ((params[0].spn + params[1].spn)*(params[0].spn + params[1].spn)) / 
	         ((params[0].spn * params[0].spn)/(params[0].n-1) + (params[1].spn * params[1].spn)/(params[1].n-1));
	var tcrit = tcrits[Math.floor(df)-1];
	var se = Math.sqrt(params[0].spn + params[1].spn);
	return {lower_bound: (params[0].mean - params[1].mean - se*tcrit), upper_bound: (params[0].mean - params[1].mean + se*tcrit)};
}


/** 
 * Records one trial of eligibility -- pushes the response and the item's
 * F3-F2 measurement to Experigen
 * @param userResponse {Number} The user's response as 1 or 0
 */
Experigen.recordEligibility = function (userResponse){
	/* pushing The f3_f2. Need to access the screen at Experigen.position-1, because
	 * this is run after Experigen.screen().advance() so we're in theory the next
	 * screen already */
	this.f3f2.push(parseFloat(Experigen._screens[Experigen.position-1].F3_F2));
	this.eligResponses.push(userResponse);
}


/**
 * The response given by {@link Experigen.calculateEligibility}.
 * @typedef calculateEligibilityReturn
 * @property prompt {String} The presentable prompt
 * @property contBText {String} The label to the continue button (quit or continue)
 * @property lower_bound {Number} The lower bound of the ttest confidence interval
 * @property upper_bound {Number} The upper bound of the ttest confidence interval
 * @property cont {boolean} The decision whether to allow continuing or not
 */


/**
 * Calculates whether the subject passed the eligibility trials. Returns an object
 * with information about passing the test, and a presentable prompt.
 * @returns {calculateEligibilityReturn} An object with the response.
 */
Experigen.calculateEligibility = function () {
	var prompt = "";
	var totest = [[],[]];
	// the input to the t-test is a pair of arrays, let's fill them up
	// totest[0] -- the "incorrect" decisions
	// totest[1] -- the "correct" decisions
	for(var i = 0; i &lt; this.f3f2.length; i++)
		totest[this.eligResponses[i]].push(this.f3f2[i]); 	

	var bounds = ttest(totest);
	
	var fail = getCookie(Experigen.settings.cookieprefix+"fail"); // have they failed before?
	
	
	if(isNaN(bounds.lower_bound) || isNaN(bounds.upper_bound)){ // we have no lower or upper bound
		prompt = "You have only marked one or no item as correct or incorrect.";
		if(fail!="yes"){
			prompt += " You have to rerun the test again.";
			Experigen.eligibilityC = false;
			setCookie(Experigen.settings.cookieprefix+"fail","yes"); // they have failed so far
		}
		else{
			Experigen.ban = true; // twice a fail is a ban
			setCookie(Experigen.settings.cookieprefix+"fail","ban");
		}
	}
	else{
		if( (bounds.upper_bound > Experigen.settings.mean_raters_difference) &amp;&amp; (bounds.lower_bound > 0)){
			prompt = "Congratulations! You are eligible to rate &lt;span class='emphasizedr'>r&lt;/span> sounds as part of our study. You will be able to skip the eligibility testing for up to five blocks of stimuli if you use the same browser on the same computer. After five blocks, you will have to take the test again: if you want to continue rating &lt;span class='emphasizedr'>r&lt;/span> sounds, you can re-take the training and eligibility test and become eligible for another five blocks. ";
			Experigen.eligibilityC = true;
			setCookie(Experigen.settings.cookieprefix+"fail","no"); // erase any failures
		}
		else{
			prompt = "We are sorry, you did not meet the accuracy criterion.";
			if(fail!="yes"){			
				prompt += " You may attempt the rating task one more time. If you do not pass on your second try, you will not be able to rate &lt;span class='emphasizedr'>r&lt;/span> sounds as part of our study.";
			
				Experigen.eligibilityC = false;
				setCookie(Experigen.settings.cookieprefix+"fail","yes");
			}
			else{
				Experigen.ban = true;
				setCookie(Experigen.settings.cookieprefix+"fail","ban");	
			}
		}
		//prompt += "&lt;br> lower bound = " + bounds.lower_bound.toFixed(2) + ", upper bound = " + bounds.upper_bound.toFixed(2);
	}
	
	return { prompt: prompt, 
			 contBText: Experigen.ban ? "    quit    " : Experigen.settings.strings.continueButton, 
			 lower_bound: bounds.lower_bound.toFixed(2),
			 upper_bound: bounds.upper_bound.toFixed(2),
			 cont: Experigen.eligibilityC };
			 
}

/**
 * Handles the press of the eligibility decision submit button, necessary
 * as the subject is either advancing or getting kicked out
 * @param that The submit button.
 * @example &amp;lt;input type="button" onClick="Experigen.calculateEligibilityButton(this)&amp;gt;"
 */
Experigen.calculateEligibilityButton = function(that) {
  if(Experigen.ban){ // if we're banned from continuing
		this.addStaticScreen("goodbye.ejs");
		this.rewind(this._screens.length-1);
  }
  else {
	if(!Experigen.eligibilityC){ // if we have to start again
		this.f3f2 = [];
		this.eligResponses = [];
		this.rewind(this.bookmark);
	}
	else{ // if we're good
		this.screen().continueButtonClick(that);
	}
  }
}


/**
 * Helper function that rewinds the experiment to a given position
 * @param bookmark {Number} The position to rewind to
 */
Experigen.rewind = function (bookmark) {
	this.position = bookmark - 1;
	Experigen.advance();
}

/**
 * Called between batches of trial blocks added to the experiment,
 * returns a "bookmark" -- the position at a given point.
 * @returns {Number} the point of the bookmark
 */
Experigen.setBookmark = function () {
	return (this._screens.length);
}

/** 
 * Returns the set of blocks already done by the subject
 * @returns {Array} The array of blocks done, from the browser cookie
*/
Experigen.getBlocksDone = function () {
	var rv = [];
	var blocks = getCookie(Experigen.settings.cookieprefix + "blocks");
	if (blocks) {
		rv = blocks.split('.');
	}
	
	return rv;
}


/**
 * Adds a block to the list the subject has done in the browser's cookie
 * @param block The block done.
*/
Experigen.addBlockDone = function(block) {
	var blocks = Experigen.getBlocksDone();
	var out = blocks.concat(block).join('.');
	setCookie(Experigen.settings.cookieprefix + "blocks",out,30);
}


/**
 * Clears all the cookies set by this experiment.
*/
Experigen.clearCookies = function() {
	setCookie(Experigen.settings.cookieprefix + "blocks","",-1);
	setCookie(Experigen.settings.cookieprefix + "fail","",-1);
}



/**
 * This function initializes the experiment
 */
Experigen.initialize = function () {
	// let's see if the subject is banned and kick them out if they are
	var ban = getCookie(Experigen.settings.cookieprefix+"fail"); 
	if(ban == "ban"){
		this.addStaticScreen("goodbye.ejs");
		return;
	}

	if(!Modernizr.audio.wav){
		this.addStaticScreen("goodbyehtml5.ejs");
		return;
	}

	// setting up some constants
	var nCatch = 20; // number of catch trials
	var bDone; 
	var runEligibility = true; // boolean -- do we have to run eligibility?
	var maxBlock = 50; // number of blocks in the experiment
	
	this.accuracyTotal = 0;
	this.accuracy = 0;
	  
	this.f3f2 = []; // the F3-F2 values of the eligibility ratings
	this.eligResponses = []; // responses to the eligibility ratings
	var prop;

	/* loading resources */
	var items  = this.resource("items"); // main stimuli
	var practice_items = this.resource("practice_items"); // training stimuli
	var test_items = this.resource("test_items"); // eligibility stimuli
	var catch_items = this.resource("catch_items"); // catch stimuli

	/** 
	 * The block run in the current experiment.
	 * @type Number
	 * @inner */
	Experigen.blockToRun = -1;

	/** 
	 * An array for the catch trials.
	 * @type Array
	 * @inner */
	Experigen.catches = [];

	var trainingBlock = []        // setting up the training block
						.concat(practice_items.subset("Exists","1")) //there is a selection of what we want
						.pairWith("view","training.ejs")
						.shuffle();
			
	var eligibilityBlock = []       // setting up the eligibility block
		.concat(test_items) 
		.pairWith("view","eligibility.ejs")
		.shuffle();


	// Let's find out whether we want to run an eligibility test
	bDone = Experigen.getBlocksDone();
	if(bDone.length == maxBlock-1){ // subject has done all the blocks, let's clear up
		bDone.length = 0;
		bDone = [];
		Experigen.clearCookies();
	}
	if(bDone.length % 5 != 0){ // only run eligibility if the subject hasn't done anything or their last eligibility test was 5 runs ago
		runEligibility = false;
	}

	
	/* Let's figure out which block we are running
	 * For this experiment, the link to the study ends in indexXX.html where XX indicates the block so that
	 * the block to run can be determined. blockToRun could also be randomized; and only index.html used simply */
	this.blockToRun = parseInt(window.location.pathname.toString().substr(window.location.pathname.toString().length-7,2),10); // this would be easier with a regexp
	if(isNaN(this.blockToRun)){
		alert("Erroneous HTML -- final 2 characters have to be numeric. The location: -" + window.location.pathname.toString() + "-");
		return;
	}
	if(this.blockToRun > this.maxBlock){
		alert("Erroneous HTML -- block number greater than " + this.maxBlock);
		return;
	}
	
	// if the loaded block is already done, say goodbye
	if($.inArray(this.blockToRun.toString(),bDone) > -1){ 
		this.addStaticScreen("blockalreadydone.ejs");
		return;
	}

	// set attemptNumber
	this.attemptNumber = bDone.length + 1;


	// set up the experiment block
	var experimentBlock = []
		.concat(items.subset("Block",this.blockToRun.toString())) // only our block
		.pairWith("view","stimulus.ejs")						 
		.concat(catch_items.chooseRandom(nCatch) // insert 20 catch trials
				.pairWith("view","catch.ejs")) // ... which are paired up with the catch view
		.shuffle();
	
	// we don't want to start with a catch trial
	while(experimentBlock[0].view=="catch.ejs"){
	  toEnd = experimentBlock.shift(); // get the first one out to toEnd
	  experimentBlock = experimentBlock.concat(toEnd); // attach it as last
	}
	
	
	// initialize the wavPlayer
	//	wp.init();

	// start section from 0
	this.sectionStart = 0;

	/***********************************************
	 * start chaining up the screens
	 ***********************************************/

//	this.addStaticScreen("intro.ejs");
//	this.addStaticScreen("demographic.ejs");
	this.sectionEnd = this.setBookmark();
	if(runEligibility){ // only if we have to run training &amp; eligibility

		this.addStaticScreen("trainingintro.ejs");
		this.preTrainingBookmark = this.setBookmark();
		this.addBlock(trainingBlock);
		this.addStaticScreen("trainingend.ejs");
		this.trainingEndBookmark = this.setBookmark();

		this.bookmark = this.setBookmark()
		this.addStaticScreen("eligibilityintro.ejs");
		this.addBlock(eligibilityBlock);
		this.addStaticScreen("eligibilitydecision.ejs");
		this.eligEndBookmark = this.setBookmark();
	}
	
	this.addStaticScreen("ratingintro.ejs");
	this.addBlock(experimentBlock);
	this.stimEndBookmark = this.setBookmark();	
	this.addStaticScreen("finalthanks.ejs");
			
	this.addStaticScreen("goodbyesucc.ejs");
	
}
</code></pre>
        </article>
    </section>




          </div>
      </div>

        <br clear="both">

      <footer>
		Experigen documentation, Daniel Szeredi 2014.
		<br>
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a> on Tue Jul 08 2014 20:04:31 GMT-0400 (EDT)
        <br>
      </footer>
      <script> prettyPrint(); </script>
    </div>
  </body>
</html>
